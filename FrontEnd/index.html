<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Live Caption Overlay</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="caption-container">
        <div id="caption-box" class="caption-box">
            <p id="caption-output">Pressione INICIAR para comeÃ§ar a legendar...</p>
        </div>

        <div id="control-panel" class="control-panel hidden">
            <button id="startButton" class="control-button"><i class="fas fa-play"></i> INICIAR</button>
            <button id="pauseResumeButton" class="control-button" disabled><i class="fas fa-pause"></i> PAUSAR</button>
            <button id="stopButton" class="control-button" disabled><i class="fas fa-stop"></i> FINALIZAR</button>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // ConfiguraÃ§Ã£o da Web Speech API (transcriÃ§Ã£o do navegador)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;

        const captionOutput = document.getElementById('caption-output');
        const startButton = document.getElementById('startButton');
        const pauseResumeButton = document.getElementById('pauseResumeButton');
        const stopButton = document.getElementById('stopButton');
        const controlPanel = document.getElementById('control-panel');
        const captionContainer = document.querySelector('.caption-container');
        
        let isListening = false;
        let isPaused = false;
        
        if (recognition) {
            recognition.continuous = true; // Continua ouvindo
            recognition.interimResults = true; // Resultados em tempo real (legenda)
            recognition.lang = 'pt-BR'; // Idioma

            // --- FUNÃ‡Ã•ES DE CONTROLE DE INTERATIVIDADE (ELECTRON) ---
            
            // Permite o clique na janela do overlay
            function enableInteraction() {
                ipcRenderer.send('set-ignore-mouse-events', false);
                controlPanel.classList.remove('hidden');
            }
            
            // Faz o mouse 'passar' pela janela (Modo Overlay)
            function disableInteraction() {
                ipcRenderer.send('set-ignore-mouse-events', true, { forward: true });
                controlPanel.classList.add('hidden');
            }

            // --- LÃ“GICA DA TRANSCRIÃ‡ÃƒO ---

            recognition.onstart = () => {
                isListening = true;
                isPaused = false;
                captionOutput.textContent = 'ðŸ”Š Ouvindo...';
                pauseResumeButton.disabled = false;
                stopButton.disabled = false;
                startButton.disabled = true;
                pauseResumeButton.innerHTML = '<i class="fas fa-pause"></i> PAUSAR';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Exibe a legenda em tempo real
                captionOutput.textContent = (finalTranscript + interimTranscript).trim() || 'ðŸ”Š Ouvindo...';
            };

            recognition.onend = () => {
                isListening = false;
                startButton.disabled = false;
                pauseResumeButton.disabled = true;
                stopButton.disabled = true;
                captionOutput.textContent = 'Pressione INICIAR para comeÃ§ar a legendar...';
            };
            
            recognition.onerror = (event) => {
                 console.error('Erro de reconhecimento:', event.error);
                 captionOutput.textContent = `Erro: ${event.error}`;
                 recognition.stop();
            }

            // --- MANIPULADORES DE BOTÃƒO ---

            if (recognition) {
                recognition.continuous = true; // OK
                recognition.interimResults = true; // OK
                recognition.lang = 'pt-BR'; // OK
                
                // ADICIONE ESTA LINHA:
                recognition.maxAlternatives = 1; // Boa prÃ¡tica

                // Se o problema persistir, adicione um timeout explÃ­cito (embora nÃ£o seja padrÃ£o na API)
                // recognition.grammars = null; // Garante que nÃ£o hÃ¡ gramÃ¡ticas complexas desnecessÃ¡rias
                // recognition.serviceURI = '...'; // NÃ£o altere, pois Ã© o serviÃ§o padrÃ£o.
            }

            startButton.addEventListener('click', () => {
                captionOutput.textContent = 'Iniciando microfone...';
                try {
                    // 1. Permite interagir com os botÃµes
                    enableInteraction(); 
                    // 2. Inicia o reconhecimento
                    recognition.start();
                } catch(e) {
                    console.error("Erro ao iniciar:", e);
                    captionOutput.textContent = 'Erro ao iniciar a transcriÃ§Ã£o. Verifique as permissÃµes.';
                    disableInteraction();
                }
            });

            pauseResumeButton.addEventListener('click', () => {
                if (isListening) {
                    if (isPaused) {
                        // VOLTAR (Play)
                        recognition.start(); 
                        isPaused = false;
                        pauseResumeButton.innerHTML = '<i class="fas fa-pause"></i> PAUSAR';
                        captionOutput.textContent = 'ðŸ”Š Retomando a escuta...';
                    } else {
                        // PAUSAR
                        recognition.abort(); // Interrompe temporariamente
                        isPaused = true;
                        pauseResumeButton.innerHTML = '<i class="fas fa-play"></i> VOLTAR';
                        captionOutput.textContent = 'â¸ï¸ Pausado.';
                    }
                }
            });

            stopButton.addEventListener('click', () => {
                recognition.stop(); // Finaliza a sessÃ£o de reconhecimento
                disableInteraction(); // Torna o overlay inerte
            });
            
            // --- HABILITAR CONTROLES INICIAIS (Clique duplo na legenda para mostrar) ---
            
            captionContainer.addEventListener('dblclick', enableInteraction);
            
        } else {
            captionOutput.textContent = 'API de Reconhecimento de Voz nÃ£o suportada pelo seu navegador/Electron.';
        }
    </script>
</body>
</html>