<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Live Caption Overlay</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="caption-container">
        <div id="caption-box" class="caption-box">
            <p id="caption-output">Pressione INICIAR para comeÃ§ar a legendar...</p>
        </div>

        <div id="control-panel" class="control-panel hidden">
            <button id="startButton" class="control-button"><i class="fas fa-play"></i> INICIAR</button>
            
            <button id="pauseResumeButton" class="control-button" disabled>
                <i class="fas fa-pause"></i> PAUSAR
            </button>
            
            <button id="stopButton" class="control-button" disabled>
                <i class="fas fa-stop"></i> FINALIZAR
            </button>
        </div>
    </div>
    <script>
        // *** IMPORTANTE: ENVOLVA TODO O SEU CÃ“DIGO DENTRO DE DOMContentLoaded ***
        // Isso garante que o JS sÃ³ tente buscar os elementos HTML APÃ“S eles existirem.
        document.addEventListener('DOMContentLoaded', () => {
            
            // Seu cÃ³digo JavaScript comeÃ§a aqui (AGORA FUNCIONARÃ):

            const { ipcRenderer } = require('electron');
            
            // As variÃ¡veis agora encontrarÃ£o os elementos no DOM
            const captionOutput = document.getElementById('caption-output');
            const startButton = document.getElementById('startButton');
            const pauseResumeButton = document.getElementById('pauseResumeButton');
            const stopButton = document.getElementById('stopButton');
            const controlPanel = document.getElementById('control-panel');
            const captionContainer = document.querySelector('.caption-container');
            
            // VariÃ¡veis de controle de Ã¡udio
            let mediaRecorder;
            let audioStream;
            let audioChunks = [];
            let isListening = false;
            let isPaused = false;

            // --- ConfiguraÃ§Ãµes de TranscriÃ§Ã£o (Para Python) ---
            const CHUNK_INTERVAL = 1500;
            const PYTHON_API_URL = 'http://127.0.0.1:5001/transcribe';
            // ----------------------------------------------------
            
            // --- FUNÃ‡Ã•ES DE CONTROLE DE INTERATIVIDADE (ELECTRON) ---
            // ... (Seu cÃ³digo de enableInteraction e disableInteraction) ...
            function enableInteraction() {
                ipcRenderer.send('set-ignore-mouse-events', false);
                controlPanel.classList.remove('hidden');
            }
            
            function disableInteraction() {
                ipcRenderer.send('set-ignore-mouse-events', true, { forward: true });
                controlPanel.classList.add('hidden');
            }


            // --- LÃ“GICA DE ÃUDIO E COMUNICAÃ‡ÃƒO COM PYTHON ---
            // ... (Seu cÃ³digo de sendAudioChunk) ...
            async function sendAudioChunk(chunk) {
                if (!chunk || chunk.size === 0) return;
                
                try {
                    const response = await fetch(PYTHON_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/octet-stream'
                        },
                        body: chunk 
                    });

                    const data = await response.json();
                    
                    if (data.success && data.transcription) {
                        const currentText = captionOutput.textContent.includes('Ouvindo...') ? '' : captionOutput.textContent;
                        let newText = data.transcription;
                        if (newText.length > 100) {
                            newText = newText.substring(newText.length - 100);
                        }
                        captionOutput.textContent = newText;
                    } else {
                        if (data.transcription && data.transcription !== "[SilÃªncio ou Ã¡udio ininteligÃ­vel]") {
                            captionOutput.textContent = data.transcription;
                        }
                    }
                } catch (error) {
                    console.error('Erro na comunicaÃ§Ã£o com o backend Python:', error);
                    captionOutput.textContent = 'Erro de Rede/Python. Verifique o servidor (porta 5001).';
                    stopRecording();
                }
            }
            
            // ... (Seu cÃ³digo de startRecording, stopProcessing, stopRecording) ...
            function startRecording() {
                captionOutput.textContent = 'Iniciando microfone...';
                
                navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 44100,
                        sampleSize: 16,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                })
                .then(stream => {
                    audioStream = stream;
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm; codecs=pcm' });
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = stopProcessing;

                    mediaRecorder.start(CHUNK_INTERVAL);
                    
                    isListening = true;
                    isPaused = false;
                    captionOutput.textContent = 'ðŸ”Š Ouvindo...';
                    pauseResumeButton.disabled = false;
                    stopButton.disabled = false;
                    startButton.disabled = true;
                    pauseResumeButton.innerHTML = '<i class="fas fa-pause"></i> PAUSAR';

                    const sendLoop = setInterval(() => {
                        if (isListening && !isPaused && audioChunks.length > 0) {
                            const audioBlob = new Blob(audioChunks, { type: 'application/octet-stream' });
                            sendAudioChunk(audioBlob);
                            audioChunks = [];
                        }
                        if (!isListening && sendLoop) clearInterval(sendLoop); 
                    }, CHUNK_INTERVAL);
                })
                .catch(error => {
                    console.error('Erro ao acessar o microfone:', error);
                    captionOutput.textContent = 'Erro: Microfone bloqueado ou inacessÃ­vel.';
                    stopRecording();
                });
            }
            
            function stopProcessing() {
                isListening = false;
                startButton.disabled = false;
                pauseResumeButton.disabled = true;
                stopButton.disabled = true;
                
                if(audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                captionOutput.textContent = 'Reconhecimento encerrado.';
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                } else {
                    stopProcessing();
                }
                disableInteraction();
            }
            
            // --- MANIPULADORES DE BOTÃƒO ---

            // A linha que falhava antes, agora funciona!
            startButton.addEventListener('click', () => { 
                enableInteraction(); 
                startRecording();
            });

            pauseResumeButton.addEventListener('click', () => {
                if (isListening) {
                    if (isPaused) {
                        mediaRecorder.resume(); 
                        isPaused = false;
                        pauseResumeButton.innerHTML = '<i class="fas fa-pause"></i> PAUSAR';
                        captionOutput.textContent = 'ðŸ”Š Retomando a escuta...';
                    } else {
                        mediaRecorder.pause(); 
                        isPaused = true;
                        pauseResumeButton.innerHTML = '<i class="fas fa-play"></i> VOLTAR';
                        captionOutput.textContent = 'â¸ï¸ Pausado.';
                    }
                }
            });

            stopButton.addEventListener('click', () => {
                stopRecording(); 
            });
            
            // --- HABILITAR CONTROLES INICIAIS (Clique duplo na legenda para mostrar) ---
            captionContainer.addEventListener('dblclick', enableInteraction);

        }); // FIM do DOMContentLoaded
    </script>
</body>
</html>